@using System.Dynamic;
@using System.Linq;
@using System.Collections.Generic;
@using DotNetNuke.Web.DDRMenu;
@using DotNetNuke.Common;
@using DotNetNuke.Entities.Portals;
@using DotNetNuke.Services.Localization;
@using R7.Epsilon.Components;
@inherits DotNetNuke.Web.Razor.DotNetNukeWebPage<dynamic>

@functions {
	string NodeActiveCssClass (MenuNode node)
	{
		return (node.Selected) ? "active" : string.Empty;
	}

	string NodeDisabledCssClass (MenuNode node)
	{
		return !node.Enabled ? "disabled" : string.Empty;
	}

	string NodeCssClasses (MenuNode node)
	{
		return (NodeActiveCssClass (node) + " " + NodeDisabledCssClass (node)).Trim ();
	}

	IList<MenuNode> GetBreadcrumbNodes (MenuNode root)
	{
		var node = root;
		var nodes = new List<MenuNode> { node };
		while (!node.Selected && node.HasChildren ()) {
			var breadcrumbNode = node.Children.FirstOrDefault (n => n.Breadcrumb);
			if (breadcrumbNode == null) {
				break;
			}
			nodes.Add (breadcrumbNode);
			node = breadcrumbNode;
		}
		return nodes;
	}

	string GetString (string resourceKey)
	{
		var resourceFileRoot = "~/Portals/_default/Skins/R7.Epsilon/App_LocalResources/Fake.ascx.resx";
		return Localization.GetString (resourceKey, resourceFileRoot);
	}

	string FormatUrl (MenuNode node)
	{
		if (string.IsNullOrEmpty (node.Url) && node.TabId == -1) {
			node.TabId = PortalSettings.Current.HomeTabId;
			node.Url = Globals.NavigateURL (PortalSettings.Current.HomeTabId);
		}

		var urlFormat = Model.UrlFormat;
		if (string.IsNullOrEmpty (urlFormat)) {
			return node.Url;
		}

		return EpsilonUrlHelper.FormatUrl (urlFormat, node.TabId, PortalSettings.Current.PortalId, HttpContext.Current.Request.QueryString);
	}
}

@helper RenderBreadcrumb(MenuNode root) {
	var nodes = GetBreadcrumbNodes (root);
	if (nodes.Count > 0) {
        <nav aria-label='@GetString("DropCrumb_AriaLabel.Text")' itemprop="breadcrumb" itemscope="" itemtype="https://schema.org/breadcrumb">
			<ol class="breadcrumb" itemscope="" itemtype="http://schema.org/BreadcrumbList">
				@foreach (var node in nodes) {
					if (node == root) {
						node.Enabled = true;
					}
					if (node.Selected) {
						<li class="breadcrumb-item @NodeCssClasses(node)" aria-current="page" itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem">
							@if (node.HasChildren ()) {
								<span class="dropdown">
									<a class="dropdown-toggle" href="#" type="button" role="button" id="btnDropCrumb_@node.TabId" data-toggle="dropdown"
											aria-haspopup="true" aria-expanded="false" itemprop="item">
										<span itemprop="name">@Html.Raw(node.Text)</span>
									</a>
									@RenderDropdownFor(node)
								</span>
							}
							else {
								<span itemprop="item">
									<span itemprop="name">@Html.Raw(node.Text)</span>
								</span>
							}
						</li>
					}
					else {
						<li class="breadcrumb-item @NodeCssClasses(node)" itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem">
							@if (node == root) {
								<a href="@FormatUrl(node)" title='@GetString("DropCrumb_Home_Tooltip.Text")' itemprop="item">
									@Html.Raw(GetString("DropCrumb_Home.Text"))
									<meta itemprop="name" content="@node.Text" />
								</a>
							}
							else {
								<a href="@FormatUrl(node)" itemprop="item"><span itemprop="name">@Html.Raw(node.Text)</span></a>
							}
						</li>
					}
				}
			</ol>
		</nav>
	}
}

@helper RenderDropdownFor(MenuNode parentNode) {
	<div class="dropdown-menu" aria-labelledby="btnDropCrumb_@parentNode.TabId">
		@foreach (var node in parentNode.Children) {
			if (node.HasChildren ()) {
				<div class="dropright">
					<a class="dropdown-item dropdown-toggle lvl2" href="#" type="button" role="button" id="btnDropCrumb_@node.TabId" data-toggle="dropdown"
							aria-haspopup="true" aria-expanded="false">
						<span itemprop="name">@Html.Raw(node.Text)</span>
					</a>
					@RenderDropdownLevel2For(node)
				</div>
			}
			else {
				<a class="dropdown-item @NodeCssClasses(node)" href="@FormatUrl(node)">@node.Text</a>
			}
		}
	</div>
}

@helper RenderDropdownLevel2For(MenuNode parentNode) {
	<div class="dropdown-menu" aria-labelledby="btnDropCrumb_@parentNode.TabId">
		<a class="h5 dropdown-item @NodeCssClasses(parentNode)" href="@FormatUrl(parentNode)">
			@parentNode.Text <i class="fas fa-angle-double-right"></i>
		</a>
		<div class="dropdown-divider"></div>
		@foreach (var node in parentNode.Children) {
			<a class="dropdown-item @NodeCssClasses(node)" href="@FormatUrl(node)">@node.Text</a>
		}
	</div>
}

@RenderBreadcrumb(Model.Source.root)

<script>
$(document).ready(function(){
	$(".breadcrumb .dropdown .dropdown-toggle.lvl2").on("click", function(e){
		$(this).next(".dropdown-menu").toggle();
		e.stopPropagation();
		e.preventDefault();
	});
});
</script>
